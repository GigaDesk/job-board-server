package graph

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.55

import (
	"context"
	"errors"
	"log"

	"github.com/GigaDesk/eardrum-server/encrypt"
	"github.com/GigaDesk/eardrum-server/graph/model"
	"github.com/GigaDesk/eardrum-server/phoneutils"
)

// CreateSchool is the resolver for the createSchool field, signs up a school to the system
func (r *mutationResolver) CreateSchool(ctx context.Context, input model.NewSchool) (*model.UnverifiedSchool, error) {
	//check if the phone number exists in the database
	phoneexists, err := phoneutils.CheckSchoolPhoneNumber(r.Sql.Db, input.PhoneNumber)
	//return an error if phone number exists in the database
	if phoneexists.Verified == true || phoneexists.Unverified == true {
		return nil, errors.New("phone number already exists")
	}
	//return any error that might be associated with checking the phone number's existence in the database
	if err != nil {
		return nil, err
	}
	//encrypt input password
	encryptedpassword, err := encrypt.HashPassword(input.Password)
	if err != nil{
		return nil, err
	}
	//create an unverified school data
	unverifiedschool := &model.UnverifiedSchool{
		Name:        input.Name,
		PhoneNumber: input.PhoneNumber,
		Password:    encryptedpassword,
		Badge:       input.Badge,
		Website:     input.Website,
	}
	//send an OTP code to the phone number associated with the unverified school record, return error id there is any
	if err := phoneutils.SendOtp(unverifiedschool.PhoneNumber); err != nil {
		return nil, err
	}
	//create an unverified school record in the database and return if operation succeeds
	if err := r.Sql.Db.Create(unverifiedschool).Error; err != nil {
		log.Println(err)
		return nil, errors.New("an unexpected error occurred while creating the school account. please try again later or contact support")
	}

	return unverifiedschool, nil
}

// VerifySchool is the resolver for the verifySchool field. it checks the validity of an OTP code in relation to the phonenumber, if valid it transfers a school's data from the unverified_schools table to the school table
func (r *mutationResolver) VerifySchool(ctx context.Context, input model.Verificationinfo) (*model.School, error) {
	//Check the validity of an OTP code
	if err := phoneutils.CheckOtp(input.PhoneNumber, input.Otp); err != nil {
		return nil, err
	}
	//declare an unverifiedschool variable
	var unverifiedschool *model.UnverifiedSchool

	// Find the first unverified school that matches the input phone number from the unverified school table

	if err := r.Sql.Db.Where("phone_number = ?", input.PhoneNumber).First(&unverifiedschool).Error; err != nil {
		log.Println("Error finding user:", err)
		return nil, errors.New("phone number was already verified or was never signed up")
	}

	// transform the unverified school model into school model and copy it
	school := &model.School{
		Name:        unverifiedschool.Name,
		PhoneNumber: unverifiedschool.PhoneNumber,
		Password:    unverifiedschool.Password,
		Badge:       unverifiedschool.Badge,
		Website:     unverifiedschool.Website,
	}

	// take the newly transformed and copied school data and transfer it into the official verified school table
	if err := r.Sql.Db.Create(school).Error; err != nil {
		return nil, errors.New("a critical error occurred while verifying the school account. our servers will be down for some time, sorry for the inconvenience")
	}

	// delete the unverified school from the unverified school table
	if err := r.Sql.Db.Delete(unverifiedschool).Error; err != nil {
		log.Println(err)
		return nil, errors.New("an unexpected error occurred while verifying the school account. please try again later or contact support")
	}
	log.Println("Finished unverified school to school data transaction")
	return school, nil
}

// SendCode is the resolver for the sendCode field, it send an otp code to the provided phone number
func (r *mutationResolver) SendCode(ctx context.Context, phoneNumber string) (*model.SendCodeStatus, error) {
	if err := phoneutils.SendOtp(phoneNumber); err != nil {
		return nil, err
	}
	sendcodestatus := &model.SendCodeStatus{
		PhoneNumber: phoneNumber,
		Success:     true,
	}
	return sendcodestatus, nil
}

// SchoolPhoneNumberExists is the resolver for the schoolPhoneNumberExists field, checks if an school's phone number already exists in both the unverified_schools and schools tables
func (r *queryResolver) SchoolPhoneNumberExists(ctx context.Context, phoneNumber string) (*model.PhoneNumberExists, error) {
	phoneexists, err := phoneutils.CheckSchoolPhoneNumber(r.Sql.Db, phoneNumber)

	if err != nil {
		return nil, err
	}

	return phoneexists, nil
}

// Mutation returns MutationResolver implementation.
func (r *Resolver) Mutation() MutationResolver { return &mutationResolver{r} }

// Query returns QueryResolver implementation.
func (r *Resolver) Query() QueryResolver { return &queryResolver{r} }

type mutationResolver struct{ *Resolver }
type queryResolver struct{ *Resolver }
